<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Baba Tillu Pro — Firebase Keys</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body style="font-family:sans-serif;background:#111;color:#eee;padding:20px">
  <h2>Baba Tillu Pro — Firebase Keys (Final Fixed)</h2>

  <div id="home">
    <h3>Enter Key</h3>
    <input id="userKeyInput" placeholder="Enter key" />
    <button onclick="unlockWithKey()">Unlock</button>
    <div id="homeMsg" style="margin-top:10px;color:#ccc"></div>
  </div>

  <div id="panel" style="display:none;margin-top:20px">
    <h3>Prediction Panel</h3>
    <div>Active Key: <span id="activeKeyLabel">—</span></div>
    <div>Expires In: <span id="expiresIn">—</span></div>
    <button onclick="logout()">Logout</button>
  </div>

  <div id="adminPanel" style="margin-top:30px">
    <h3>Admin Panel</h3>
    <button onclick="createKey(30)">Create 30 min Key</button>
    <button onclick="createKey(60)">Create 1 hour Key</button>
    <button onclick="createKey(1440)">Create 1 day Key</button>
    <div id="keysList" style="margin-top:15px;padding:10px;background:#222"></div>
  </div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBs7eQyMrcN8kJWMHl2ac2UZHlYQ6DypD8",
    authDomain: "terminal-xxrr.firebaseapp.com",
    databaseURL: "https://terminal-xxrr-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "terminal-xxrr",
    storageBucket: "terminal-xxrr.appspot.com",
    messagingSenderId: "722753278120",
    appId: "1:722753278120:web:bfa37aab39635a4e57f29d"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  firebase.auth().signInAnonymously()
    .then(()=>console.log("✅ Firebase signed in"))
    .catch(e=>console.error("Auth error", e));

  function generateKeyString(len=8){
    const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
    let s=""; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
    return s;
  }

  function createKey(minutes){
    const key = generateKeyString(10);
    const expiresAt = Date.now() + minutes*60000;
    const obj = { key, expiresAt, minutes };
    db.ref("keys/"+key).set(obj).then(()=>{
      alert("Key created: "+key);
      renderKeysList();
    }).catch(err=>alert("Error: "+err.message));
  }

  function renderKeysList(){
    const el=document.getElementById("keysList");
    el.innerHTML="Loading...";
    db.ref("keys").once("value").then(snap=>{
      el.innerHTML="";
      if(!snap.exists()){el.innerHTML="No keys yet";return;}
      snap.forEach(child=>{
        const v=child.val();
        const div=document.createElement("div");
        div.style.margin="5px 0";
        div.innerHTML = `<b>${v.key}</b> — expires ${new Date(v.expiresAt).toLocaleString()}
          <button onclick="deleteKey('${v.key}')">Delete</button>`;
        el.appendChild(div);
      });
    });
  }

  function deleteKey(k){
    db.ref("keys/"+k).remove().then(()=>renderKeysList());
  }

  function unlockWithKey(){
    const key=document.getElementById("userKeyInput").value.trim();
    if(!key){document.getElementById("homeMsg").innerText="Enter key";return;}
    db.ref("keys/"+key).once("value").then(snap=>{
      if(!snap.exists()){document.getElementById("homeMsg").innerText="Invalid key";return;}
      const v=snap.val();
      if(v.expiresAt<Date.now()){document.getElementById("homeMsg").innerText="Key expired";return;}
      sessionStorage.setItem("bt_active", JSON.stringify(v));
      document.getElementById("home").style.display="none";
      document.getElementById("panel").style.display="block";
      document.getElementById("activeKeyLabel").innerText=v.key;
      updateExpiry(v.expiresAt);
    });
  }

  function updateExpiry(expAt){
    function upd(){
      const diff=expAt-Date.now();
      if(diff<=0){document.getElementById("expiresIn").innerText="Expired";logout();return;}
      const m=Math.floor(diff/60000),s=Math.floor((diff%60000)/1000);
      document.getElementById("expiresIn").innerText=m+"m "+s+"s";
    }
    upd();
    setInterval(upd,1000);
  }

  function logout(){
    sessionStorage.removeItem("bt_active");
    document.getElementById("home").style.display="block";
    document.getElementById("panel").style.display="none";
  }

  renderKeysList();
</script>
</body>
</html>
